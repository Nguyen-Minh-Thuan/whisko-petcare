name: Deploy Go app to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Disable host key checking
        run: echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh

      - name: SSH Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ubuntu/whisko-petcare
            git pull origin main

            echo "Stopping existing containers..."
            cd deployments
            docker-compose down

            echo "Creating .env file from GitHub Secrets..."
            cat > ../.env << 'EOF'
            PORT=${{ secrets.PORT }}
            MONGO_URI=${{ secrets.MONGO_URI }}
            MONGO_DATABASE=${{ secrets.MONGO_DATABASE }}
            JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
            JWT_TOKEN_DURATION=${{ secrets.JWT_TOKEN_DURATION }}
            PAYOS_CLIENT_ID=${{ secrets.PAYOS_CLIENT_ID }}
            PAYOS_API_KEY=${{ secrets.PAYOS_API_KEY }}
            PAYOS_CHECKSUM_KEY=${{ secrets.PAYOS_CHECKSUM_KEY }}
            PAYOS_PARTNER_CODE=${{ secrets.PAYOS_PARTNER_CODE }}
            PAYOS_BASE_URL=${{ secrets.PAYOS_BASE_URL }}
            PAYOS_RETURN_URL=${{ secrets.PAYOS_RETURN_URL }}
            PAYOS_CANCEL_URL=${{ secrets.PAYOS_CANCEL_URL }}
            CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }}
            CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }}
            CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}
            CLOUDINARY_FOLDER=${{ secrets.CLOUDINARY_FOLDER }}
            EOF

            echo "ðŸ“¦ Installing/Updating Nginx and Certbot..."
            sudo apt update
            sudo apt install -y nginx certbot python3-certbot-nginx

            echo "ðŸ”§ Configuring Nginx..."
            sudo mkdir -p /var/www/certbot
            
            # Create Nginx configuration
            sudo tee /etc/nginx/sites-available/whisko-api > /dev/null << 'NGINX_EOF'
            # Redirect HTTP to HTTPS
            server {
                listen 80;
                listen [::]:80;
                server_name api.whisko.shop;

                location /.well-known/acme-challenge/ {
                    root /var/www/certbot;
                }

                location / {
                    return 301 https://$host$request_uri;
                }
            }

            # HTTPS Server
            server {
                listen 443 ssl http2;
                listen [::]:443 ssl http2;
                server_name api.whisko.shop;

                # SSL Certificates
                ssl_certificate /etc/letsencrypt/live/api.whisko.shop/fullchain.pem;
                ssl_certificate_key /etc/letsencrypt/live/api.whisko.shop/privkey.pem;
                
                # SSL Configuration
                ssl_protocols TLSv1.2 TLSv1.3;
                ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
                ssl_prefer_server_ciphers off;
                ssl_session_timeout 1d;
                ssl_session_cache shared:SSL:50m;
                ssl_session_tickets off;
                
                # Security Headers
                add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
                add_header X-Frame-Options "SAMEORIGIN" always;
                add_header X-Content-Type-Options "nosniff" always;
                add_header X-XSS-Protection "1; mode=block" always;

                # Request limits
                client_max_body_size 20M;

                # Logging
                access_log /var/log/nginx/whisko-api-access.log;
                error_log /var/log/nginx/whisko-api-error.log;

                # Proxy to Go API
                location / {
                    proxy_pass http://localhost:8080;
                    proxy_http_version 1.1;
                    
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_set_header X-Forwarded-Host $host;
                    
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection "upgrade";
                }
            }
            NGINX_EOF

            # Enable site
            sudo rm -f /etc/nginx/sites-enabled/default
            sudo ln -sf /etc/nginx/sites-available/whisko-api /etc/nginx/sites-enabled/

            # Obtain SSL certificate if not exists
            if [ ! -f /etc/letsencrypt/live/api.whisko.shop/fullchain.pem ]; then
                echo "ðŸ”’ Obtaining SSL certificate..."
                sudo systemctl stop nginx
                sudo certbot certonly --standalone -d api.whisko.shop --email ${{ secrets.SSL_EMAIL }} --agree-tos --non-interactive || true
            else
                echo "âœ… SSL certificate already exists"
            fi

            # Test Nginx configuration
            sudo nginx -t

            # Reload Nginx
            sudo systemctl enable nginx
            sudo systemctl restart nginx

            echo "ðŸ³ Building and starting containers..."
            docker-compose up -d --build
            
            echo "ðŸ“Š Checking container logs..."
            docker-compose logs --tail=30

            echo "ðŸ”¥ Configuring firewall..."
            sudo ufw allow 'Nginx Full' || true
            sudo ufw --force enable || true

            echo "âœ… Deployed successfully with HTTPS!"
            echo "ðŸŒ Access your API at: https://api.whisko.shop"
